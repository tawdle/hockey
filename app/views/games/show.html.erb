<%= javascript_tag do %>
  $(function() {
    App.translations =  <%= {penalties: t("penalties") }.to_json.html_safe %>;
    App.players = new App.Players(<%= json_for(@game.players).html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.goals = new App.Goals(<%= json_for(@game.goals).html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.infractions = <%= Penalty::Codes.to_json.html_safe %>;
    App.periods = <%= Game::Periods.to_json.html_safe %>;
    App.feedItems = new App.FeedItems(<%= json_for(@game.activity_feed_items).html_safe %>, {gameId: <%= @game.id %>});
    App.game = new App.Game(<%= json_for(@game, :methods => [:faye_uri]).html_safe %>);
    App.penalties = new App.Penalties(<%= json_for(@game.penalties).html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.markerView = new App.Marker.MarkerView({ model: App.game, el: ".content" });
  });
<% end %>

<% if @game.started_at %>
  <p>This game started <time class="timeago" datetime="<%= @game.started_at.iso8601 %>"><%= distance_of_time_in_words_to_now(@game.started_at) %></time>.</p>
<% end %>
<% if @game.ended_at %>
  <p>This game ended <time class="timeago" datetime="<%= @game.started_at.iso8601 %>"><%= distance_of_time_in_words_to_now(@game.ended_at) %></time>.</p>
<% end %>


<% if @game.live? %>
  <% if can? :mark, @game %>
    <div id="game-status" style="text-align: center;">
      <p class="active">This game is ready to play. Press <i class="icon-play"></i> to start the next period.</p>
      <p class="playing">This game is playing. Press <i class="icon-pause"></i> to pause the game clock.</p>
      <p class="paused">This game is paused. Press <i class="icon-play"></i> to resume.</p>
      <p class="finished">This game has ended. When you have completed recording all items, press: <%= link_to "Complete Game", complete_game_path(@game), :class => "btn", :method => :post %> </p>
    </div>
  <% end %>

  <div id="start-stop-clock">
    <% if can? :mark, @game %>
      <a href="#" class="btn btn-large add-penalty" title="Add Penalty"><i class="icon-flag icon-2x"></i></a>
      <%= link_to "<i class='icon-play icon-2x'></i>".html_safe, "#", :id => "game-start", :class => "btn btn-large btn-success" %> 
      <%= link_to "<i class='icon-pause icon-2x'></i>".html_safe, "#", :id => "game-pause", :class => "btn btn-large btn-warning" %>
    <% end %>

    <span id="game-period" class="label"></span>
    <span id="game-clock" class="label"></span>
    <%= link_to "<i class='icon-stop icon-2x'></i>".html_safe, "#", :id => "game-stop", :class => "btn btn-large btn-danger" if can? :mark, @game %>
  </div>

  <div class="row-fluid">
    <%= render :partial => "team_box", :locals => {:team => @game.home_team, :home_or_visiting => :home } %>
    <%= render :partial => "team_box", :locals => {:team => @game.visiting_team, :home_or_visiting => :visiting } %>
  </div>

<% elsif %>

  <h2>
    <%= link_to @game.home_team.full_name, @game.home_team %> <i>vs</i>
    <%= link_to @game.visiting_team.full_name, @game.visiting_team %>
  </h2>

  <p><em>Playing in <%= link_to @game.league.name, @game.league %></em></p>

  <%= @game.start_time.to_s(:long) %> at <%= @game.location.name %>

  <% if @game.scheduled? %>
    <p>This game is scheduled to start <time class="timeago" datetime="<%= @game.start_time.iso8601 %>"><%= distance_of_time_in_words_to_now(@game.start_time) %></time>.</p>
    <% if can? :mark, @game %>
      <%= render :partial => "marker_checklist" %>
    <% end %>
  <% elsif @game.canceled? %>
    <p>This game has been canceled.</p>
  <% elsif @game.completed? %>
    <p>This game is over.</p>
  <% end %>
<% end %>

<div class="well">
  <h2>Activity Feed</h2>

  <% if current_user %>
    <%= form_for(ActivityFeedItem.new(:game => @game), :remote => true) do |f| %>
      <div class="field pull-left" style="margin-right: 10px;" >
        <%= f.text_field :message, :class => "span4", :placeholder => "Enter status message here..." %>
      </div>

      <%= f.hidden_field :game_id, :value => f.object.game.to_param %>

      <div class="actions">
        <%= f.submit "Post", :class => "btn btn-primary" %>
      </div>
    <% end %>
  <% end %>

  <table id="feed-items" class="table">
    <thead>
      <tr>
        <th>Avatar</th>
        <th>Name</th>
        <th>Message</th>
        <th>When</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="penalty-editor modal hide">
  <div class="modal-header"><h3><i class="icon-flag"></i> <span class="title"><%= t "penalty.editor.title" %></span></h3></div>
  <div class="modal-body">
    <form>

      <fieldset>
        <legend><%= Team.model_name.human %></legend>
        <div class="penalty-team">
          <label class="radio">
            <input type="radio" id="penalty-team-<%= @game.home_team_id %>" value="<%= @game.home_team_id %>" name="penalty[team_id]"></input>
            <%= @game.home_team.full_name %>
          </label>
          <label class="radio">
            <input type="radio" id="penalty-team-<%= @game.visiting_team_id %>" value="<%= @game.visiting_team_id %>" name="penalty[team_id]" ></input>
            <%= @game.visiting_team.full_name %>
          </label>
        </div>
      </fieldset>


      <fieldset>
        <legend><%= Player.model_name.human %></legend>
        <div class="penalty-player">
          <div id="penalty-players-team-<%= @game.home_team_id %>"></div>
          <div id="penalty-players-team-<%= @game.visiting_team_id %>"></div>
        </div>
      </fieldset>

      <fieldset>
        <legend><%= Penalty.human_attribute_name(:category) %></legend>
        <div class="penalty-category">
          <select>
            <%= options_for_select(Penalty::Codes.keys.map {|category| [t(category, :scope => "penalties.categories"), category] }) %>
          </select>
        </div>
      </fieldset>

      <fieldset class="clearfix">
        <legend><%= Penalty.human_attribute_name(:infraction) %></fieldset>
        <div class="penalty-infraction">
          <div class="penalty-infraction-radios">
            <% abbr = t("penalties.infractions.abbreviations") %>
            <% Penalty::Codes[:minor][:common].keys.each do |id| %>
              <input id="penalty-infraction-radio-<%= id %>" type="radio" name="penalty[infraction]" value="<%= id %>"></input>
              <label for="penalty-infraction-radio-<%= id %>" class="btn"><%= abbr[id] || t(id, :scope => "penalties.infractions") %></label>
            <% end %>
          </div>

          <div>
            <select style="width: 92%;"></select>
          </div>
        </div>
      </fieldset>
    </form>
  </div>
  <div class="modal-footer">
    <%= link_to "Cancel", "#", :class => "cancel" %>
    <%= link_to "Save", "#", :class => "save btn btn-primary" %>
  </div>
</div>

<script type="text/html" id="feed-item">
<td><img src="{{= avatar_thumbnail_url }}" height="50" width="50"></td>
<td>{{= creator }}</td>
<td>{{= message }}</td>
<td><time class="timeago" datetime="{{= created_at }}"></time></td>
</script>

<% content_for(:head) do %>
  <%= javascript_include_tag AsyncMessaging::FAYE_CONFIG[:script] %>
<% end %>

<script type="text/html" id="penalty-view">
<td>{{= App.periods[period] }}</td>
<td>{{= App.displaySeconds(elapsed_time) }}</td>
<td>{{= App.players.get(player_id).get("jersey_number") + (serving_player_id ? " (served by " + App.players.get(serving_player_id).get("jersey_number") + ")" : "") }}</td>
<td>{{= App.translations.penalties.infractions[infraction] + " - " + App.translations.penalties.categories[category] }}</td>
<td>{{= App.humanize(state) }}</td>
<td class="timer" style="white-space: nowrap"></td>
<td style="white-space: nowrap">
  <%= link_to "#", :class => "edit btn btn-small" do %>
    <i class="icon-edit"></i>
  <% end %>
  <%= link_to "#", :class => "delete btn btn-small btn-danger" do %>
    <i class="icon-remove"></i>
  <% end %>
</td>
</script>

<script type="text/html" id="goal-view">
<td>{{= App.periods[period] }}</td>
<td>{{= App.displaySeconds(elapsed_time) }}</td>
<td>{{= players.join("<br>") }}</td>
<td>
  <%= link_to "#", :class => "edit btn btn-small" do %>
    <i class="icon-edit"></i>
  <% end %>
  <%= link_to "#", :class => "delete btn btn-small btn-danger" do %>
    <i class="icon-remove"></i>
  <% end %>
</td>
</script>

<script type="text/html" id="player-radio">
  <input id="penalty-player-radio-{{= id }}" type="radio" name="penalty[player_id]" value="{{= id }}"></input>
  <label for="penalty-player-radio-{{= id }}" class="btn">{{= jersey_number }}</label>
</script>

<script type="text/html" id="player-checkbox">
  <tr>
    <input name="game[game_players_attributes][{{= id }}][player_id]" value="{{= id }}" type="hidden" />
    <td>
      <label class="checkbox inline" for="player_{{= id }}">
        <input id="player_{{= id }}" name="game[game_players_attributes][{{= id }}][selected]" type="checkbox" checked="checked" value="true" />
        {{= name_and_number }}
      </label>
    </td>
    <td>
      <select id="game_player_select_{{= id }}" name="game[game_players_attributes][{{= id }}][role]" value="player">
        <% Player::Roles.each do |role| %>
          <option value="<%= role %>"><%= role.to_s.humanize %></options>
        <% end %>
      </select>
    </td>
  </tr>
</script>

