<%= javascript_tag do %>
  $(function() {
    App.dispatcher = _.clone(Backbone.Events);
    App.players = new App.Players(<%= @game.players.to_json.html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.goals = new App.Goals(<%= @game.goals.to_json.html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.infractions = <%= Penalty::Infractions.to_json.html_safe %>;
    App.periods = <%= Game::Periods.to_json.html_safe %>;
    App.feedItems = new App.FeedItems(<%= @game.activity_feed_items.to_json.html_safe %>, {gameId: <%= @game.id %>});
    App.game = new App.Game(<%= @game.to_json.html_safe %>);
    App.penalties = new App.Penalties(<%= @game.penalties.to_json.html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.gameView = new App.GameView({ model: App.game, el: ".content" });
    App.homeView = new App.TeamBoxView({ el: "#home-team", teamId: <%= @game.home_team_id %> });
    App.visitingView = new App.TeamBoxView({ el: "#visiting-team", teamId: <%= @game.visiting_team_id %> });
    App.feedItemsView = new Backbone.CollectionView({
      el: "#feed-items",
      collection: App.feedItems,
      modelView: App.FeedItemView,
      emptyListCaption: "There are no activity feed items yet for this game."
    });
    App.feedItemsView.render();
  });
<% end %>

<% if @game.live? %>
  <div id="game-status" style="text-align: center;">
    <p class="active">This game is ready to play. Press <i class="icon-play"></i> to start the next period.</p>
    <p class="playing">This game is playing. Press <i class="icon-pause"></i> to pause the game clock.</p>
    <p class="paused">This game is paused. Press <i class="icon-play"></i> to resume.</p>
    <p class="finished">This game has ended. When you have completed recording all items, press: <%= link_to "Complete Game", complete_game_path(@game), :class => "btn", :method => :post %> </p>
  </div>

  <div id="start-stop-clock">
    <%= link_to "<i class='icon-play icon-2x'></i>".html_safe, start_game_path(@game, :format => :json), :method => :post, :remote => true, :id => "game-start", :class => "btn btn-large btn-success", :style => displayStyle(@game.can_start?) %> 
    <%= link_to "<i class='icon-pause icon-2x'></i>".html_safe, stop_game_path(@game, :format => :json), :method => :post, :remote => true, :id => "game-pause", :class => "btn btn-large btn-danger", :style => displayStyle(@game.can_pause?) %>

    <span id="game-clock" class="label"></span>
  </div>

  <div class="row-fluid">
    <%= render :partial => "team_box", :locals => {:team => @game.home_team, :home_or_visiting => :home } %>
    <%= render :partial => "team_box", :locals => {:team => @game.visiting_team, :home_or_visiting => :visiting } %>
  </div>

<% elsif %>

  <h2 class="page-header">
    <%= @game.home_team.name %> <i>vs</i>
    <%= @game.visiting_team.name %>
    <br />
    <small>
      <%= @game.start_time.to_s(:long) %> at
      <%= @game.location.name %>
    </small>
  </h2>

  <% if @game.scheduled? %>
    <p>This game is scheduled to start <time class="timeago" datetime="<%= @game.start_time.iso8601 %>"><%= distance_of_time_in_words_to_now(@game.start_time) %></time>.</p>
    <div class="actions">
      <%= link_to "Activate", activate_game_path(@game), :class => "btn btn-primary", :method => :post %>
      <%= link_to "Cancel", game_path(@game), :class => "btn btn-warning", :method => :delete %>
    </div>
  <% elsif @game.canceled? %>
    <p>This game has been canceled.</p>
  <% elsif @game.completed? %>
    <p>This game is over.</p>
  <% end %>
<% end %>

<%= form_for(ActivityFeedItem.new(:game => @game), :remote => true) do |f| %>
  <div class="field pull-left" style="margin-right: 10px;" >
    <%= f.text_field :message, :class => "span4", :placeholder => "Enter status message here..." %>
  </div>

  <%= f.hidden_field :game_id, :value => f.object.game.to_param %>

  <div class="actions">
    <%= f.submit "Post", :class => "btn btn-primary" %>
  </div>
<% end %>

<table id="feed-items" class="table">
  <thead>
    <tr>
      <th>Avatar</th>
      <th>Name</th>
      <th>Message</th>
      <th>When</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="text/html" id="feed-item">
<td><img src="{{= avatar_thumbnail_url }}" height="50" width="50"></td>
<td>{{= creator }}</td>
<td>{{= message }}</td>
<td><time class="timeago" datetime="{{= created_at_iso8061 }}"></time></td>
</script>

<% content_for(:head) do %>
  <%= javascript_include_tag AsyncMessaging::FAYE_CONFIG[:script] %>
<% end %>

<script type="text/html" id="penalty-view">
<td>{{= App.periods[period] }}</td>
<td>{{= App.displaySeconds(elapsed_time) }}</td>
<td>{{= App.players.get(player_id).get("jersey_number") + (player_id != serving_player_id ? " (served by " + App.players.get(serving_player_id).get("jersey_number") + ")" : "") }}</td>
<td>{{= App.humanize(infraction) + " (" + App.humanize(category) + ")" }}</td>
<td>{{= App.humanize(state) }}</td>
<td class="timer" style="white-space: nowrap"></td>
<td style="white-space: nowrap">
  <%= link_to "#", :class => "start btn btn-small btn-success" do %>
    <i class="icon-play"></i>
  <% end %>
  <%= link_to "#", :class => "edit btn btn-small" do %>
    <i class="icon-edit"></i>
  <% end %>
  <%= link_to "#", :class => "delete btn btn-small btn-danger" do %>
    <i class="icon-remove"></i>
  <% end %>
</td>
</script>

<script type="text/html" id="goal-view">
<td>{{= App.periods[period] }}</td>
<td>{{= App.displaySeconds(elapsed_time) }}</td>
<td>{{= jersey_numbers.join(", ") }}</td>
<td>
  <%= link_to "#", :class => "edit btn btn-small" do %>
    <i class="icon-edit"></i>
  <% end %>
  <%= link_to "#", :class => "delete btn btn-small btn-danger" do %>
    <i class="icon-remove"></i>
  <% end %>
</td>
</script>

<script type="text/html" id="player-checkbox">
  <tr>
    <input name="game[game_players_attributes][{{= id }}][player_id]" value="{{= id }}" type="hidden" />
    <td>
      <label class="checkbox inline" for="player_{{= id }}">
        <input id="player_{{= id }}" name="game[game_players_attributes][{{= id }}][selected]" type="checkbox" checked="checked" value="true" />
        {{= name_and_number }}
      </label>
    </td>
    <td>
      <select name="game[game_players_attributes][{{= id }}][role]" value="player">
        <% GamePlayer::Roles.each do |role| %>
          <option value="<%= role %>"><%= role.to_s.humanize %></options>
        <% end %>
      </select>
    </td>
  </tr>
</script>

