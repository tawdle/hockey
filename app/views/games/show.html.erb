<%= javascript_tag do %>
  $(function() {
    App.game = new App.Game(<%= @game.to_json.html_safe %>);
    App.gameView = new App.GameView({ model: App.game });
    App.goals = new App.Goals(<%= @game.goals.to_json.html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.penalties = new App.Penalties(<%= @game.penalties.to_json.html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.homeGoalsView = new App.GoalsView({ collection: App.goals, el: "#home-team" });
    App.visitingGoalsView = new App.GoalsView({ collection: App.goals, el: "#visiting-team" });
    App.homePenaltiesView = new App.PenaltiesView({ collection: App.penalties, el: "#home-team" });
    App.visitingPenaltiesView = new App.PenaltiesView({ collection: App.penalties, el: "#visiting-team" });
    App.players = new App.Players(<%= @game.players.to_json.html_safe %>, <%= {gameId: @game.id}.to_json.html_safe %>);
    App.infractions = <%= Penalty::Infractions.to_json.html_safe %>;
  });
<% end %>

<script type="text/html" id="goal-form">
  <form>
    <div id="goal-primary">
      <label for="player0">Player who scored...</label>
      <select id="player0" name="player[0]" class="span3">{{= _.template($("#player-options").html(), { players: players, selectedId: ids[0] }) }}</select>
    </div>

    <div id="goal-assist">
      <label for="player1">Player who assisted...</label>
      <select id="player1" name="player[1]" class="span3">{{= _.template($("#player-options").html(), { players: players, selectedId: ids[1] }) }}</select>
    </div>

    <div id="goal-secondary-assist">
      <label for="player2">And also...</label>
      <select id="player2" name="player[2]" class="span3">{{= _.template($("#player-options").html(), { players: players, selectedId: ids[2] }) }}</select>
    </div>

    <%= link_to "Cancel", "#", :id => "goal-cancel" %>
    <%= submit_tag "Save", :class => "btn btn-small btn-primary" %>

  </form>
</script>

<script type="text/html" id="player-options">
<option></option>
{{ _.each(players, function(player) { }}
   <option value="{{= player.id }}" {{= player.id == selectedId ? "selected" : ""}}>{{= player.get("jersey_number") }}</option> 
{{ }); }}
</script>

<script type="text/html" id="penalty-form">
  <form>
    <div class="penalty-player">
      <select name="player"></select>
    </div>
    <div class="penalty-serving-player">
      <select name="player-serving"></select>
    </div>
    <div class="penalty-category">
      <select>
        <option value="" selected disabled>Type of penalty</option>
        <% Penalty::Infractions.keys.each do |category| %>
          <option value="<%= category %>"><%= category.to_s.humanize %></option>
        <% end %>
      </select>
    </div>
    <div class="penalty-infraction">
      <select></select>
    </div>
    <div class="penalty-minutes">
      <input type="number" placeholder="Penalty minutes" min="0" max="60" step="1"></input>
    </div>

    <div class="pull-right">
      <%= link_to "Cancel", "#", :class => "cancel" %>
      <input type="submit" class="btn btn-primary" value="Save"></input>
    </div>
  </form>
</script>



<% if @game.live? %>
  <% if @game.active? %>
    <p>This game is ready to play. Press <i class="icon-play"></i> to start the <%= (@game.period + 1).ordinalize %> period.</p>
  <% elsif @game.playing? %>
    <p>This game is playing. Press <i class="icon-pause"></i> to pause the game clock.</p>
  <% elsif @game.paused? %>
    <p>This game is paused. Press <i class="icon-start"></i> to resume.</p>
  <% elsif @game.finished? %>
    <p>This game has ended. When you have completed recording all items, press: </p>
    <%= link_to "Complete Game", complete_game_path(@game), :class => "btn" %>
  <% end %>

  <div id="start-stop-clock">
    <%= link_to "<i class='icon-play icon-2x'></i>".html_safe, start_game_path(@game, :format => :json), :method => :post, :remote => true, :id => "game-start", :class => "btn btn-large btn-success", :style => displayStyle(@game.can_start?) %> 
    <%= link_to "<i class='icon-pause icon-2x'></i>".html_safe, stop_game_path(@game, :format => :json), :method => :post, :remote => true, :id => "game-pause", :class => "btn btn-large btn-danger", :style => displayStyle(@game.can_pause?) %>

    <span id="game-clock" class="label">
      <%= @game.clock.elapsed_time_hms %>
    </span>
  </div>

  <div class="row-fluid">
    <%= render :partial => "team_box", :locals => {:home_or_visiting => "home" } %>
    <%= render :partial => "team_box", :locals => {:home_or_visiting => "visiting" } %>
  </div>

<% elsif %>

  <h2 class="page-header">
    <%= @game.home_team.name %> <i>vs</i>
    <%= @game.visiting_team.name %>
    <br />
    <small>
      <%= @game.start_time.to_s(:long) %> at
      <%= @game.location.name %>
    </small>
  </h2>

  <% if @game.scheduled? %>
    <p>This game is scheduled to start <time class="timeago" datetime="<%= @game.start_time.iso8601 %>"><%= distance_of_time_in_words_to_now(@game.start_time) %></time>.</p>
    <div class="actions">
      <%= link_to "Activate", activate_game_path(@game), :class => "btn btn-primary", :method => :post %>
      <%= link_to "Cancel", game_path(@game), :class => "btn btn-warning", :method => :delete %>
    </div>
  <% elsif @game.canceled? %>
    <p>This game has been canceled.</p>
  <% elsif @game.completed? %>
    <p>This game is over.</p>
  <% end %>
<% end %>

<%= render :partial => "activity_feed", :locals => { :new_activity_feed_item => ActivityFeedItem.new(:game => @game), :activity_feed_items => @game.activity_feed_items, :in_game_context => true } %>

<% content_for(:head) do %>
  <%= javascript_include_tag "http://localhost:8000/faye/client.js" %>
<% end %>


